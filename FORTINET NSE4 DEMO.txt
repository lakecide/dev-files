NSE4 TRAINING

****Security fabric cannot work in multiple vdom mode. can only work in root vdom and customer vdom mode only.
**you authorize downstream devices on both the root fortigate and the fortianalyzer
**security fabric score cards are, security posture,fabric coverage and optimization
**security fabric score can be viewed only on the root fortigate node


**CP- Content processor
-high speed content inspection, - not bound to interface, closer to applications, encryption and decryption(SSL),-AV.
*SP Security Processor
-Directly attached to network interfaces, - increase system performance by accelerating IPS
*NP Network Processor
-packet processing, - NP6 provided NTurbo, - Directly attached to network interface
**SOC4 System on a chip processor
-Optimized performance for entry level, - SOC4 platforms include NTurbo
***Modes of Operation
NAT mode
Transparent mode:Fortigate operates at layer 2. -Interfaces do not have IPs. -Cannot route packets, only forward or block. - Configured per VDOM.
**Fortiguard AV and IPS uses tcp port 443
**Web filtering, DNS FfILTERING nad Antispam do live queries to fortiguard services and can use https over port 443,53 or 8888 or UDP ON port 53 or 8888
**fortiguard servers starts with 173.243



The internet services database is being populated and updated automatically by fortiguard services.
Fortiguard services is needed for intelligence and updates to the fortigate
**Policy route is more higher and will be consulted ahead of dynamic routing table that even consists of static routes.
**When one external IP is mapped to a internal server ip in a one to one version, it is called VIP.
**A VIP object will be created before a destination NAT is implemented and the VIP object will be connected to the destination on the firewall policy to properly create the NAT.
**Central NAT and firewall policy NAT (DNAT or SNAT) can not be used at the same time, one has to be choosen
**If you are using the VIP object, you do not need to apply NAT in the policy because you are using DNAT. If you are using SNAT, because traffic originates from the inside, NAT is then required.
****If you configure SNAT using outgoing interface and the VIP object is active, the policy will use the VIP instead of the NAT rule. so to use SNAT and outgoing interface, disable VIP or just use dynamic IP pool instead of the use outgoing interface.
**dynamic ip pool cannot work with central NAT
**if the policy does not match any NATing, the private IP will go directly and connect to the external IP without any NAT.

**When you create a VIP object in DNAT, the VIP object must be mapped to the internal server and musl be linked to the destination when creating the firewall policy.
**Any ip from the external ip subnet range that has not been used before can be used to create the VIP.
*****When using the vip object for DNAT, NAT should be disabled in firewall policy becase NAT there is used for source NAT.
**once VIP is activated, it overrides even NAT that is using outgoing interface, unless ip pools is configured
noting can override ip pools
central NAT and firewall policy NAT cannot work together
Multiple central NAT policy can be created to match firewall policy criteria
****very key*** if you have central NAT being used, and you need to create a VIP DNAT, it can be done and a firewall policy needs to be created to match the destination host of the server and not the DNAT object itself and it will work and you can even leave the destination to be all. and it will work
***To map one external VIP to one internal server ip that is being load balanced between multiple ips e.g clustered servers will have to be done from the CLI.
****One internal to another internal is directly done on VIP dnat page which is the default mode.
****ICMP packets does not have any protocol state so it will always show proto state 00
**while UDP packets with one way traffic will show proto value of 0 and bidirectional UDP shows a value of 1 protostate 01
***TCP with proto state 01 means the session has establish
**To diagnose total number of TCP sessions for an ippool, use diagnose firewall ippool-all stats <ippool name>



You have to delete all firewall policy before you can activate central NAT
********from cli (get system session list

**Get session list command shows the log history of connections and their details

AUTHENTICATION
DIagnose test authserver ldap NAme_of_group  to diagnose ldap connection

NTP server is needed for logging
fortigate logging options are
-using siem, forticloud, fortimanager, fortianalyzer, local
--logs older than 7days are deleted on local disk which is default (can be change depending on storage)

CERTIFICATES
If there is no ssl inspection, the firewall wont know whats inside an encrypted traffic.
via the certificate, the firewall can query the domain name to know what is about to be accessed.
--Full ssl inspection will show more than domain, it will show data, AV scanning details and even IPS.
--When protecting a single server, its best to use protecting ssl server option under server certificate.
--When protecting clients, you can choose ssl cert inspection or full ssl inspection as the inspection mode and also choose multiple clients connecting to multiple servers
***Even with end to end encryption, with a certificate inspection, the firewall is able to trick both parties and query the server domain and ask for its certificate  to be sure if it is not malicious so as to secure the client.
***If you use a full ssl inspection, you will have to select the firewall certificate (fortinet certificate) to scan traffic which you will have to import into other clients browsers since it is a local CA and not a globally issued certicate.
**deep inspection will decrypt the payload and inspect whats in the packet
**Full Inspection on inbound traffic(trying to preotect a server)-options for enable ssl inspection will be protect ssl server.
**NB** When protecting a server from inbound connections using the certificate, you have to use proxy-based inspection mode because the firewall will server as a proxy between both connections and also do full inspection if we want to try the AV profile.
***NB** Another scenerio when protecting a web server is to upload the web server certificate into fortigate so the firewall can use the certificate to decrypt traffic before it gets in

****************ARCHITECTURE port1 = WAN  , port 3 = LAN 

****WEB FILTERING
-Inspection mode is flow based or proxy based.
**flow inspection is the default
-uses single-pass direct approach pattern matching to identify possible attacks
-file is scanned on a flow basis as it passes through fortigate
-requires fewer processing resources.
-faster scanning.
**PROXY Based
-more thorough inspection
-complete content is scanned
- the firewall will proxy the connection
-more resource intensive
-provides higher level of threat protection

**With Flow based comes with NGFW mode
-features 2 modes- profile based and policy based which is based on how policy and profiles are placed and linked.
***NGFW MODE
Profile based - requires application control and web filtering profiles
-apply the profiles to the policy
- applicable to proxy based and flow based inspection modes
Policy based - application control and web filtering applied directly to the policy
-does not require app control and web filtering profiles.
-applicable to flow based inspection mode only

***INSPECTION ORDER
-URL-STATIC URL FILTER(BLOCK/EXCEMPT/ALLOWED)-FORTIGUARD CATEGORY FILTER(BLOCK/ALLOWED)-ADVANCED FILTERS(BLOCK/ALLOWED)-DISPLAY PAGE.

for web filtering category, the options are allow,monitor,block,warn,authenticate.
&**Manual Override can help you query category of a website and even change the category local on the fortigate and wont affect the fortiguard .
**You can also overide filter policy by allowing some users or group to override the filter policy by authenticating
**Static url filter will be applied first to see if a website has been exempted or blocked before the local fortigate and fortiguard is queried for category.
Web content filter requires deep ssl inspection to be up and the actions are excempt or block. Web content filter allows you to add banned word to be searched while users visit web pages


***APPLICATION MONITORING
Category options are monitor, allow, block and quarantine
Application filter overrides can help you add exemptions of applications and filters. Filters can be application signature behaviours e.g bandwidth utilization while by application can be allow youtube. and you have to arrange it in order of priority to take better effect.

ANTI VIRUS
**Flow based inspection, fortigate buffers and sends the files simultaeneously to the client and only holds the last packet which will be scanned, if it is malicious, it blocks it else, it releases it to the client.
**while in the proxy based inspection, the whole file will be received and scanned by the fortigate before it send it to the client.
********Difference between flow and proxy based is the content disarm and reconstruction.
AV can scan up to 10mb of file depending on the capacity of the firewall
**AV block page contains: filename, virus name, website host and URL, username and group if authentication is enable and link to fortiguard encyclopedia.
Proxy based antivirus scanning cannot be uploaded to either CP or NP processors
WAF is available only in proxy based mode
Fortigate models with NP6,NP7 and SOC4 can benefit from NTurbo acceleration while models that have a CP8 or CP9 support offloading of IPS pattern matching to the content processor
**diagnose test application ipsmonitor ?
1: display IPS engine information
2: toggle IPS engine enable/disable status (shutdown ips engine completely)
3 display restart log
5: toggle bypass status (IPS engine remains active but does not inspect traffic)

****IPS Fail Open is triggered when the IPS socket buffer is full and new packets cant be added for inspection.


SSL VPN
Configuring SSLVPN
Setup user accounts and groups for the remote SSLVPN users
configure sslvpn portals
configure sslvpn settings
create a firewall policy to and from the sslvpn interface

ldap.firstbanknigeria.com port 389


NSE4 INFRASTRUCTURE
****************ARCHITECTURE port1 = WAN, Port2 WAN (backup)  , port 3 = LAN

Fortigate working in NAT mode means it is working as a router not necessary doing NATing
In transparent mode, means its working as a switch forwarding frames.
-For any session, fortigate performs a routing table lookup TWICE, -for the first packet sent by the originator and -for the first reply packet coming from the responder.
-ROUTING information is written to the session table.
-All other packets for that session will use the same path (-Exception: After a routing table change, route information is flusshed form the sessions and must be relearned.
**In fortigate, the AD for static route is 10.
**Priority is for tie breaking incase 2 rules have the same AD
****If you want to do loadbalancing with 2 routes, the AD must be the same.
***get router info routing-table all or routing-table database to check the routing table from the CLI.

************Configuring link-monitor can only be done from CLI only with the command,
**config system link-monitor
-edit (port1-monitor)-can be anything
-set srcintf port1
-set server (e.g 8.8.8.8)
-set gateway-ip (gateway ip)
-set protocol ping
-set update-static-route enable ---to remove the route from the table if it goes down

***To view the routing table on the GUI, GOTO dashboard > NETWORK
******Load balancing can only be done from the CLI.
-How fortigate load balance, the MODE is by: - source-ip based(means same source use same l ink)
-weight based
-usage based (is set by a value threashold and if it is reached, failover to another interface)
source-dest-ip-based (means if its same dest ip, use same port)

****For policy routes where you can configure a specific protocol or port to use a specified interface. check Network > Policy route option to use this function.
**- to check the policy route table, you can use ***diagnose firewall proute list**
***********The policy route has more priority than the normal routing table.

***SD-WAN
-before tou can proceed with the configuration, static route needs to be removed so as not to affect the routing. and SDWAN will be configured to replace it.
-Also delete or modify firewall policy that takes traffic from one side and to another side.
**Then goto Network > SDWAN interfaces and configure all the ports you have
***there can only be one SDWAN interface per vdom
**When implementing SDWAN, you must still configure a default route but it does not require gateway because the fortigate device will figure the gateway based on the interface joined to the SDWAN link
**the firewall policy selected will automatically use the link between the sdwan link
**You can configure multiple SLA target per performance SLA- but can can only use one SLA target in one performance SLA.
**Link quality is measured by =(a*latency + b*jitter + c*packet loss + d*bandwidth) and this quality are measured by each on 10% which can also be changed on CLI
**SDWAN Rules priority for lowest cost SLA flow
-the SLA Targets are checked to see if a link meets it
-Then the cost is checked
-then lastly the interface preference is looked
**for the SDWAN Rules maximize bandwidth
-interfaces that meets the rule set, traffic will be load balanced accross these interfaces to maximize usage. cost will not be used as priority here.



****To configure load-balancing on sdwan via the CLI
- config virtual-wan-link
- set load-balance-mode ? (? to view options available)
- end

**- The a new static route can now be created with sdwan as the interface (NB, when you choose the sdwan as the interface, you wont have the option to select next hop as the fortigate will take care of that.
**- then a new firewall policy will be created with outgoing interface SD-WAN.

***get router info routing-table all to check the routing table from the CLI
*****SDWAN has by default AD of 1 which cannot be changed or configured
**You have done loadbalancing. then you can now create SDWAN rules

*When choosing outgoing interface, manual, best quality and lowest cost SLA will select an outgoing interface to be used, while maximize bandwidth(SLA) will use the best interface available.


VDOM
Vdom can be enbled from the GUI or the CLI
**There are 2 types of VDOM mode, split task VDOM (VDOM for security fabric which will consist of 2 vdoms only and will support security fabric usage) while the multi-mode VDOM which will consist of multiple vdoms, up to 10 by default and does not support security fabric.
VDOM split a fortigate into multiple virtual devices
there are some configurations that are global to the fortigate while some are confined to each VDOM created.
***What are the things that makes the VDOM different. 1. interfaces needs to be linked to VDOMS
**There are different admin profiles that can be created on the fortigate for management pourposes.
The super admin profile which will have access to the global system settings and also to all the VDOMS created and a prof admin profile which will only have access to the a specific VDOM only. A Prof admin can be configured on 2 different vdoms.
***There is a inter VDOM link that can link traffic from one VDOM to the other which is a virtual link.
**NB** Each VDOM has its own operational mode e.g One vdom can be in NAT mode while another in transparent mode.
****Profiles can be pushed from the global mode to appear in the VDOM, eg, AV profile can be pushed from the global lvel and it can be used on the  VDom and cant be deleted inside the VDOM
You acn create a VDOM link by going to interface > under create new, you will see VDOM link. (NB THE IP/netmask should be in /30)
**Split VDOM only has 2 vdoms, the root and the FG-Traffic vdom. in this vdom, you cannot add any other VDOM.
***by default The root vdom IN THE split vdom mode is also the management VDOM
**Multi-vdom option gives you the opportunity to add multiple vdoms
**NB**iF the upstream vdom is in split task mode, it can allow the downstream fortigate to join the security fabric in the root and fg-traffic mode alone.
***While if the downstream fortigate is also in split task mode, it can only connect via the downstream root vdom to the upstream device security fabric.
**Recursive DNS means the fortigate will consult its own database first when a user makes a DNS request before forwarding to another dns server. Non RECURSIVE means the fortigate will only consult its own db while forward to system dns means what it means.
**NB* Management VDOM is root by default and can be changed to any VDOM in multi-VDOM mode
**Settings that affects all configured VDOMS ARE:
-Hostname, HA settings, Fortiguard settings, system time and administrative accounts
***Inter VDOM links, connecting 2 or more VDOMS together. to achieve this, atleast one VDOM must be in NAT mode. wont work on transparent to transparent mode.
***NB** Routes are required (static routes) to properly route packets between vdoms


****NB**** To enable VDOM on fortigate from the CLI only, use
 # config system global
 # set vdom-admin enable or set vdom-mode multi-vdom
 # end
OR
 # config vdom
 # edit vdom

to configure a vdom
# config vdom
# edit ?
# get router info routing-table

****To configure routing per vdom
*- In global mode, you create the virtual interface
- then go to each vdom to configure default gateway routing 
***- Then goto each vdom to configure firewall policy (one from lan to vlink and the root from vlink to the internet)

****You can also configure the vdoms to be independent

*****TRANSPARENT OPERATION MODE
you can assign management ip to the fortigate device as the device will be acting as a switch.
**you can only switch the operation mode of a vdom in the CLI only (eg, from nat to transparent)

IPSEC
-AH provides integrity but not encryption and AH is not used by fortigate
***Protocol used by IPSEC are IKE (1 AND 2) and ESP

**PHASE 1 - How it works
1. Authenticate peers 
-pre-shared key or digital signature
-extended authentication (XAuth)
2. Negotiate on bidirectional SA (called IKE sa)
-in IKE v1, two possible ways are
  *-main mode and aggressive mode.
-not the same as IPSEC SA
-encrypted tunnel for diffie-hellman (DH)
3. DH exchange for secret keys
*****IKE Phase 1 negotiation process needed
(-Hash , -Authentication, -Group, -Lifetime, -Encryption) All ISAKMP policy
**Phase 1 is responsible for creating a secure channel between the 2 vpn connection
**ISAKMP will be used to define the policy that will handle the authentication and encryption and hashing fuction
**Phase 1 is going to negotiate the ISAKMP POLICY.

**For encryption, DES, 3DES and AES are supported.
**For Algorithm, DH(Deffie-Hellman) algorithm is used to establish the secret keys betwen the two vpn connection.
**hashing Algorithm MD5 and SHA provides data integrity
******** The first step is authentication which preshared keys or RSA signatures is possible
***The process is to first negotiate security associations where IKEV1/IKEV2 comes in
**AH then provices authentication and also does integrity check for the outer IP header. or
*ESP provides encapsulation and encryption to the traffic. ESP does not do integrity check for the outer ip address but does the check for the encapsulated ip.
***NB** The goal for phase 1 is to create ISAKMP SA and UDP500 while the goal for phase 2 is to create IPSEC SA.
***Phase 2 then provides security for the data while phase is the one establishing the connection and is the management.
******NB***While the tunnel is formed, at layer 3 you would see IP protocol while at layer 4 you would see the ESP protocol for the trasport.
**SPI is like the port mapped with the data that flows through the network.
AH and ESP are both encapsulation protocol.


*****MAIN MODE
-The first packet doesnt have the peer ID, so the responder cannot use it to identify the initiator
-this mode works well in P2P VPNs and for responders with only one dialup VPN
-This mode might not work well for responders with multiple dialup VPNs- the peers IP address is dynamic

**Main mode is best used when the connection selected is not dialup, if it is dialup which means there can be multiple users connecting, aggressive mode is best used in the case so you can specify who and who will be connecting using their peer id. i.e main mode is best used when the connection is static to static.
when using dialup mode, the remote subnet is best left to be all 0s if you specify one peer id connection .

***For Dialup connection ipsec, you dont need to configure static route on the dialup server fortigate, but a static route is needed on the remote client fortigate
**For site to site vpn, a static route is also needed on both fortigates to make it work

***When using the wizard to create the site to site vpn, all configurations will be created even static route will be created, also the firewall policy will be created automatically

Diagnose debug enabled

*********IPSEC TROUBLESHOOTING
diagnose debug application ike -1
diagnose debug enable
*****diagnose debug reset
diagnose debug disable


FSSO (Fortinet single signon)
There are different mode in which the fortigate can learn login details so as to efforlessly allow the users to login without the need to authenticate any more.
--DC Agent mode process where the DC agent sends login information to the collector via port 8003(UDP) before the collector now sends to the fortigate all in real time.
--Collector agent based Polling mode process does not have an agent so the collector agent will be the one to be pooling the information from the DC (Domain controller) via port 443.
--Agentless mode(polling) means the fortigate will be the one polling the information directly from the DC via tcp 445.
***How to view the currently logged in users: by using the CLI, diagnose debug authd fsso list or using the dashboard > Users&Devices > Firewall users then click on the show all FSSO logons
login details that will be pulled are, username,hostname, ip address and group
(to debug connection between the DC and the fortigate, diagnose debug enable and then diagnose debug application authd 8256)
***diagnose debug reset to stop debug session.
***diagnose debug authd fsso list to see all authenticate users via fsso


***HIGH AVAILABILITY****
You can have up to 4 fortigate working as a cluster
Primary fortigate election
**The fortigate with the highest number of connected port takes the primary root fortigate if equal,
**the election moves to HA uptime, the device with the highest time wins 
--diagnose sys ha dump-by vcluster shows
----FGV... uptime/reset_cnt=7814/0
    FGV... uptime/reset_cnt=0/1 (zero is for the device uptime with lower HA uptime and 1 is the number of times HA uptime has been reset for the device) and the next negotiation and another tie breaker is:
**Priority which can be set on each device and the number can be between 0 to 255. the one with higher priority wins. and if the priority is the same, the tie breaker will be the :
**SERIAL NUMBER: The highest serial number takes the root fortigate
**NB. Once an election takes place and the primary goes out and a new device is elected as primary, once the old primary comes back, it becomes secondary unless forced manually to be primary.
**diagnose sys ha checksum show is the command to show the checksum value of the fortigates in the HA cluster, if the checksums are the same, that means they are in sync.

***Using the primary CLI, you can connect to any seconday CLI *because once a device wins the election, you will only be able to connect to that device CLI. YOU CAN SWITCH with,
*execute ha manage <cluster_id> <admin_username>
to list index numbers for each fortigate, use **execute ha manage ?

FOR HA override disabled which is the default.
1) number of monitored interfaces
2) HA uptime
3) priority
4) serial number

FOR HA override enabled
1) number of monitored interfaces
2) priority
3) HA uptime
4) serial number

*********watch HA video on youtube with virtual IP creation

PROXY
**Transparent Proxy:
--Transparent proxy intercepts requests but only inspects, no changes in clients configuration required to implement a web proxy.
--requests are sent from the client browser to the servers IP address and not the proxy.
**Explicit Proxy
__Clients must be configured to use an explicit web proxy, clients sends requests to the proxy IP and port not directly to the website.
--the web proxy listens for packets sent to its ip address and port number

******Configuring Web proxy
--Explixit web proxy
----Enale explicit web proxy, indicating which interfaces the explicit web proxy will listen on
--create proxy policies to allow, deny, or inspect traffic.
--configure each clients browser to connect through the proxy.
--Transparent web proxy
---ceate regular firewall polixy to match the traffic
--enable http-policy-redirect on the matching firewall policy
--create proxy policies to allow, deny or inspect traffic.

*****For explicit web proxy,
-enable under feature requests and configure the proxy under network tab
-create authentication (by creating authentication scheme and rule to match the scheme)
- then configure the proxy polixy

***DIAGNOSTICS
-get hardware nic port1
-get system arp
-diagnose sytem top 1

***diagnosing to sniff packets
-----diagnose sniffer packet any "icmp and host <interface connecting to-to be sniffed>" 4  (4 is to enable you see the ports and ip)
******The below command will show you what occurs in the firewall
----diagnose debug flow filter clear -----to clear any previous filter
-----diagnose debug flow filter proto 1  then
------diagnose debug flow filter addr <target address>
------diagnose debug enable
-------diagnose debug flow trace start 3 ( 3 means the number of packet you want to see)


